jobs:
  - job: Ssetup
    timeoutInMinutes: 360
    pool:
      vmImage: vs2017-win2016
    variables:
      MINGW_UPPER: MINGW64
      MINGW_LOWER: mingw64
      MINGW_ARCH: x86_64
      CATCH_VER: catch-1.6.0-1-any
    strategy:
      maxParallel: 5
    steps:
      - script: |
          git clone https://github.com/lazka/msys2-ci-base.git %CD:~0,2%\msys64
          %CD:~0,2%\msys64\usr\bin\rm -rf %CD:~0,2%\msys64\.git
        displayName: Install MSYS2
      - script: |
          set PATH=%CD:~0,2%\msys64\usr\bin;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem
          %CD:~0,2%\msys64\usr\bin\pacman --noconfirm -Syyuu
        displayName: Update MSYS2
      - script: |
          set PATH=%CD:~0,2%\msys64\usr\bin;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem
          %CD:~0,2%\msys64\usr\bin\pacman --noconfirm --needed -S git base-devel mingw-w64-$(MINGW_ARCH)-toolchain
          %CD:~0,2%\msys64\usr\bin\pacman --noconfirm -Scc
        displayName: Install Toolchain
      - script: |
          set PATH=C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem
          %CD:~0,2%\msys64\usr\bin\sed -i "s|#CacheDir.*|CacheDir=/c/Users/%USERNAME%/AppData/Local/Temp|g" /etc/pacman.conf
        displayName: CI Preparation

  - job: CATCH
    dependsOn: Setup
    timeoutInMinutes: 360
    pool:
      vmImage: vs2017-win2016
    variables:
      MINGW_UPPER: MINGW64
      MINGW_LOWER: mingw64
      MINGW_ARCH: x86_64
      CATCH_VER: catch-1.6.0-1-any
    strategy:
      maxParallel: 5
    steps:
    - script: |
          cd catch
          %CD:~0,2%\msys64\usr\bin\bash -lc "makepkg-mingw -sCLf --noconfirm"
          cd ..
      displayName: Build catch
      env:
        MSYSTEM: $(MINGW_UPPER)
        CHERE_INVOKING: yes
        MINGW_INSTALLS: $(MINGW_LOWER)
    - task: PublishBuildArtifacts@1
      displayName: Publish catch
      continueOnError: true
      inputs:
        pathtoPublish: $(Build.SourcesDirectory)/catch/mingw-w64-$(MINGW_ARCH)-$(CATCH_VER).pkg.tar.xz
        artifactName: $(MINGW_ARCH)-$(CATCH_VER)